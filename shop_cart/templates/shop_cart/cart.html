{% extends "base.html" %}
{% load static %}
{% block carousel %}
{% endblock carousel %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">

{% block main %}
<div class="container mt-5">
    <h2 class="fw-bold">–ö–æ—Ä–∑–∏–Ω–∞</h2>
    <div class="row">
        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: —Ç–æ–≤–∞—Ä—ã -->
        <div class="col-md-8">
            <table class="table">
                <thead>
                <tr>
                    <th>–¢–æ–≤–∞—Ä</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–ö–æ–ª-–≤–æ</th>
                    <th>–°—É–º–º–∞</th>
                    <th></th>
                </tr>
                </thead>
                <tbody id="cart-items">
                {% for item in cart.items.all %}
                <tr>
                    <td>
                        <img src="{{ item.product.image.url }}" width="50">
                        {{ item.product.name }}
                    </td>
                    <td><b>{{ item.product.price }} —Å—û–º</b></td>
                    <td>
                        <button class="btn btn-outline-secondary btn-sm update-quantity"
                                data-product="{{ item.product.id }}" data-action="decrease">-
                        </button>
                        <span>{{ item.quantity }}</span>
                        <button class="btn btn-outline-secondary btn-sm update-quantity"
                                data-product="{{ item.product.id }}" data-action="increase">+
                        </button>
                    </td>
                    <td><b>{{ item.get_total_price }} —Å—û–º</b></td>
                    <td>
                        <button class="btn btn-danger btn-sm remove-from-cart" data-product="{{ item.product.id }}">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>

                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            <a href="{{ previous_page }}" class="btn btn-light">‚Üê –ö –ø–æ–∫—É–ø–∫–∞–º</a>

            <a href="{% url 'shop_cart:clear' %}" class="btn btn-dark">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</a>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: —Ä–∞—Å—á—ë—Ç -->
        <div class="col-md-4">
            <div class="p-4 border rounded">
                <h4 class="fw-bold">–†–∞—Å—á–µ—Ç</h4>
                <p>–°—É–º–º–∞: <b id="total-price">{{ cart.get_total_cost }} —Å—û–º</b></p>
                <a href="#!" class="btn btn-primary">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>



            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤
        document.querySelectorAll(".update-quantity").forEach(button => {
            button.addEventListener("click", function () {
                let productId = this.dataset.product;
                let action = this.dataset.action;

                fetch(`/cart/update/${productId}/${action}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "Content-Type": "application/json"
                    }
                }).then(() => {
                    location.reload();  // üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                });
            });
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
        document.querySelectorAll(".remove-from-cart").forEach(button => {
            button.addEventListener("click", function () {
                let productId = this.dataset.product;

                fetch(`/cart/remove/${productId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "Content-Type": "application/json"
                    }
                }).then(() => {
                    location.reload();  // üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                });
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF-—Ç–æ–∫–µ–Ω–∞
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                let cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>


{% endblock main %}



